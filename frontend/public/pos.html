<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Prestige.POS</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

body {
  background: #000;
  color: #fff;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  overflow: hidden;
  height: 100vh;
  height: 100dvh;
  touch-action: pan-y;
}

/* CAMERA */
#camera {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: 1;
}

/* TOP BAR */
.top-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 56px;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  z-index: 100;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.logo {
  font-size: 18px;
  font-weight: 700;
  letter-spacing: -0.5px;
}

.status-badge {
  font-size: 11px;
  padding: 4px 10px;
  background: rgba(0,255,136,0.15);
  color: #00ff88;
  border-radius: 12px;
  font-weight: 600;
}

/* SCAN AREA */
.scan-area {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 85%;
  max-width: 340px;
  aspect-ratio: 16/9;
  z-index: 10;
}

.scan-frame {
  position: relative;
  width: 100%;
  height: 100%;
  border: 2px solid #00ff88;
  border-radius: 16px;
  box-shadow: 0 0 0 2px rgba(0,0,0,0.3), 0 0 40px rgba(0,255,136,0.4);
}

.corner {
  position: absolute;
  width: 20px;
  height: 20px;
  border: 3px solid #00ff88;
}

.corner.tl { top: -2px; left: -2px; border-right: 0; border-bottom: 0; border-radius: 16px 0 0 0; }
.corner.tr { top: -2px; right: -2px; border-left: 0; border-bottom: 0; border-radius: 0 16px 0 0; }
.corner.bl { bottom: -2px; left: -2px; border-right: 0; border-top: 0; border-radius: 0 0 0 16px; }
.corner.br { bottom: -2px; right: -2px; border-left: 0; border-top: 0; border-radius: 0 0 16px 0; }

.scan-line {
  position: absolute;
  left: 10%;
  right: 10%;
  height: 2px;
  background: linear-gradient(90deg, transparent, #00ff88, transparent);
  box-shadow: 0 0 10px #00ff88;
  animation: scan 2s ease-in-out infinite;
}

@keyframes scan {
  0%, 100% { top: 10%; opacity: 0; }
  50% { top: 50%; opacity: 1; }
  100% { top: 90%; opacity: 0; }
}

.scan-hint {
  position: absolute;
  bottom: -40px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 13px;
  color: rgba(255,255,255,0.7);
  white-space: nowrap;
}

/* FEEDBACK TOAST */
.toast {
  position: fixed;
  top: 72px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  padding: 14px 20px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
  z-index: 200;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
  max-width: 85%;
  text-align: center;
  border: 1px solid rgba(0,255,136,0.3);
}

.toast.show { opacity: 1; }
.toast.success { background: rgba(0,255,136,0.2); border-color: #00ff88; }
.toast.warning { background: rgba(255,159,10,0.2); border-color: #ff9f0a; }

/* BOTTOM BAR */
.bottom-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  padding: 12px 16px calc(12px + env(safe-area-inset-bottom));
  z-index: 100;
  border-top: 1px solid rgba(255,255,255,0.1);
}

.bottom-buttons {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
}

.cart-btn {
  flex: 2;
  height: 54px;
  background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
  border: none;
  border-radius: 14px;
  font-size: 17px;
  font-weight: 700;
  color: #000;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  box-shadow: 0 4px 20px rgba(0,255,136,0.3);
  transition: transform 0.1s;
}

.cart-btn:active { transform: scale(0.97); }

.summary-btn {
  flex: 1;
  height: 54px;
  background: rgba(255,159,10,0.2);
  border: 1px solid rgba(255,159,10,0.4);
  border-radius: 14px;
  font-size: 15px;
  font-weight: 700;
  color: #ff9f0a;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.1s;
}

.summary-btn:active { transform: scale(0.97); }

.cart-badge {
  background: rgba(0,0,0,0.3);
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 15px;
}

.manual-btn {
  width: 100%;
  height: 44px;
  background: transparent;
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  color: rgba(255,255,255,0.7);
}

.manual-btn:active { background: rgba(255,255,255,0.05); }

/* CART MODAL */
.modal {
  position: fixed;
  inset: 0;
  background: #000;
  z-index: 300;
  display: none;
  flex-direction: column;
}

.modal.show { display: flex; }

.modal-header {
  height: 56px;
  background: rgba(0,0,0,0.95);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.modal-title {
  font-size: 18px;
  font-weight: 700;
}

.close-btn {
  width: 32px;
  height: 32px;
  background: rgba(255,255,255,0.1);
  border: none;
  border-radius: 8px;
  color: #fff;
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-content {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}

.cart-item {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.item-info {
  flex: 1;
  min-width: 0;
}

.item-name {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 4px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.item-code {
  font-size: 12px;
  color: rgba(255,255,255,0.5);
}

.item-price {
  font-size: 18px;
  font-weight: 700;
  color: #00ff88;
  margin-left: 12px;
}

.remove-btn {
  width: 32px;
  height: 32px;
  background: rgba(255,59,48,0.15);
  border: 1px solid rgba(255,59,48,0.3);
  border-radius: 8px;
  color: #ff3b30;
  font-size: 18px;
  margin-left: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: rgba(255,255,255,0.4);
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.modal-footer {
  background: rgba(0,0,0,0.95);
  padding: 16px 16px calc(16px + env(safe-area-inset-bottom));
  border-top: 1px solid rgba(255,255,255,0.1);
}

.total-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  font-size: 20px;
  font-weight: 700;
}

.total-price {
  color: #00ff88;
}

.checkout-btn {
  width: 100%;
  height: 54px;
  background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
  border: none;
  border-radius: 14px;
  font-size: 17px;
  font-weight: 700;
  color: #000;
}

.checkout-btn:disabled {
  opacity: 0.5;
  background: rgba(255,255,255,0.1);
  color: rgba(255,255,255,0.3);
}

/* DAILY SUMMARY STYLES */
.summary-hero {
  background: linear-gradient(135deg, rgba(0,255,136,0.15) 0%, rgba(0,204,106,0.1) 100%);
  border: 1px solid rgba(0,255,136,0.2);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 20px;
  text-align: center;
}

.summary-date {
  font-size: 13px;
  color: rgba(255,255,255,0.5);
  margin-bottom: 8px;
}

.summary-amount {
  font-size: 48px;
  font-weight: 700;
  color: #00ff88;
  margin-bottom: 8px;
}

.summary-count {
  font-size: 15px;
  color: rgba(255,255,255,0.7);
}

.summary-section {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
}

.section-title {
  font-size: 14px;
  font-weight: 600;
  color: rgba(255,255,255,0.7);
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.difference-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: rgba(255,255,255,0.03);
  border-radius: 8px;
  margin-top: 12px;
}

.difference-positive {
  color: #00ff88;
}

.difference-negative {
  color: #ff3b30;
}

.stat-row {
  display: flex;
  justify-content: space-between;
  padding: 10px 0;
  font-size: 15px;
}

.stat-label {
  color: rgba(255,255,255,0.6);
}

.stat-value {
  font-weight: 600;
}

.comparison {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  margin-left: 8px;
}

.comparison.positive {
  background: rgba(0,255,136,0.15);
  color: #00ff88;
}

.comparison.negative {
  background: rgba(255,59,48,0.15);
  color: #ff3b30;
}

.action-btn {
  width: 100%;
  height: 50px;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 10px;
}

.btn-primary {
  background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
  color: #000;
}

.btn-secondary {
  background: rgba(255,255,255,0.1);
  color: #fff;
}

/* MANUAL INPUT MODAL */
.input-modal {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0,0,0,0.98);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  padding: 24px 16px calc(24px + env(safe-area-inset-bottom));
  border-radius: 20px 20px 0 0;
  z-index: 400;
  transform: translateY(100%);
  transition: transform 0.3s;
}

.input-modal.show { transform: translateY(0); }

.input-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 8px;
}

.input-subtitle {
  font-size: 13px;
  color: rgba(255,255,255,0.5);
  margin-bottom: 20px;
}

.input-group {
  margin-bottom: 16px;
}

.input-label {
  font-size: 13px;
  color: rgba(255,255,255,0.7);
  margin-bottom: 8px;
  display: block;
}

.input-label .required {
  color: #ff3b30;
}

.input-field {
  width: 100%;
  height: 50px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 12px;
  padding: 0 16px;
  color: #fff;
  font-size: 16px;
}

.input-field:focus {
  outline: none;
  border-color: #00ff88;
  background: rgba(255,255,255,0.08);
}

.input-field:disabled {
  opacity: 0.5;
  background: rgba(255,255,255,0.02);
}

.input-field.error {
  border-color: #ff3b30;
}

.btn-group {
  display: flex;
  gap: 12px;
  margin-top: 20px;
}

.btn-cancel, .btn-add {
  flex: 1;
  height: 50px;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
}

.btn-cancel {
  background: rgba(255,255,255,0.1);
  color: #fff;
}

.btn-add {
  background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
  color: #000;
}

.btn-add:disabled {
  opacity: 0.4;
  background: rgba(255,255,255,0.1);
}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="top-bar">
  <div class="logo">Prestige.POS</div>
  <div class="status-badge" id="status">HazÄ±r</div>
</div>

<!-- CAMERA -->
<video id="camera" autoplay playsinline muted></video>

<!-- SCAN AREA -->
<div class="scan-area">
  <div class="scan-frame">
    <div class="corner tl"></div>
    <div class="corner tr"></div>
    <div class="corner bl"></div>
    <div class="corner br"></div>
    <div class="scan-line"></div>
  </div>
  <div class="scan-hint">Barkodu kameraya tutun</div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- BOTTOM BAR -->
<div class="bottom-bar">
  <div class="bottom-buttons">
    <button class="cart-btn" id="cartBtn">
      ðŸ›’ Sepet
      <span class="cart-badge" id="cartBadge">0</span>
    </button>
    <button class="summary-btn" id="summaryBtn">
      ðŸ“Š<br>GÃ¼n Sonu
    </button>
  </div>
  <button class="manual-btn" id="manualBtn">Manuel Barkod Gir</button>
</div>

<!-- CART MODAL -->
<div class="modal" id="cartModal">
  <div class="modal-header">
    <div class="modal-title">Sepet</div>
    <button class="close-btn" id="closeCart">Ã—</button>
  </div>
  <div class="modal-content" id="cartContent"></div>
  <div class="modal-footer">
    <div class="total-row">
      <span>Toplam</span>
      <span class="total-price" id="totalPrice">â‚º0.00</span>
    </div>
    <button class="checkout-btn" id="checkoutBtn">Ã–deme Al</button>
  </div>
</div>

<!-- DAILY SUMMARY MODAL -->
<div class="modal" id="summaryModal">
  <div class="modal-header">
    <div class="modal-title">GÃ¼n Sonu</div>
    <button class="close-btn" id="closeSummary">Ã—</button>
  </div>
  <div class="modal-content" id="summaryContent">
    <!-- Content populated by JS -->
  </div>
</div>

<!-- MANUAL BARCODE MODAL -->
<div class="input-modal" id="inputModal">
  <div class="input-title">Manuel Barkod</div>
  <div class="input-subtitle">Barkod numarasÄ±nÄ± girin</div>
  <div class="input-group">
    <input type="tel" class="input-field" id="barcodeInput" placeholder="Barkod numarasÄ±" autofocus>
  </div>
  <div class="btn-group">
    <button class="btn-cancel" id="cancelInput">Ä°ptal</button>
    <button class="btn-add" id="addManual">Tara</button>
  </div>
</div>

<!-- PAYMENT SELECTION MODAL -->
<div class="input-modal" id="paymentModal">
  <div class="input-title">Ã–deme Åžekli</div>
  <div class="input-subtitle" id="paymentTotal">â‚º0.00</div>
  
  <button class="action-btn btn-primary" id="paymentCash" style="margin-bottom: 12px;">
    ðŸ’µ Nakit
  </button>
  
  <button class="action-btn btn-primary" id="paymentCard" style="margin-bottom: 12px;">
    ðŸ’³ Kart
  </button>
  
  <button class="action-btn btn-secondary" id="cancelPayment">
    Ä°ptal
  </button>
</div>

<!-- QUICK ADD PRODUCT MODAL -->
<div class="input-modal" id="quickAddModal">
  <div class="input-title">ÃœrÃ¼n BulunamadÄ±</div>
  <div class="input-subtitle">HÄ±zlÄ± Ã¼rÃ¼n ekle</div>
  
  <div class="input-group">
    <label class="input-label">Barkod</label>
    <input type="text" class="input-field" id="quickBarcode" disabled>
  </div>
  
  <div class="input-group">
    <label class="input-label">Fiyat <span class="required">*</span></label>
    <input type="number" step="0.01" class="input-field" id="quickPrice" placeholder="0.00" inputmode="decimal" autofocus>
  </div>
  
  <div class="input-group">
    <label class="input-label">ÃœrÃ¼n AdÄ± (opsiyonel)</label>
    <input type="text" class="input-field" id="quickName" placeholder="ÃœrÃ¼n adÄ± girebilirsiniz">
  </div>
  
  <div class="btn-group">
    <button class="btn-cancel" id="cancelQuickAdd">Ä°ptal</button>
    <button class="btn-add" id="saveQuickAdd">Kaydet ve Ekle</button>
  </div>
</div>

<script src="https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js"></script>
<script>
// ========================================
// DATABASE (IndexedDB) - Version 2
// ========================================
const DB_NAME = 'PrestigePOS';
const DB_VERSION = 2;
let db;

function initDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onerror = () => reject(request.error);
    request.onsuccess = () => {
      db = request.result;
      resolve(db);
    };
    
    request.onupgradeneeded = (e) => {
      const database = e.target.result;
      const oldVersion = e.oldVersion;
      
      // Store 1: Products
      if (!database.objectStoreNames.contains('products')) {
        const productStore = database.createObjectStore('products', { keyPath: 'barcode' });
        productStore.createIndex('name', 'name', { unique: false });
      }
      
      // Store 2: Transactions (renamed from 'sales')
      if (!database.objectStoreNames.contains('transactions')) {
        const txStore = database.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
        txStore.createIndex('businessDate', 'businessDate', { unique: false });
        txStore.createIndex('timestamp', 'timestamp', { unique: false });
        txStore.createIndex('paymentType', 'paymentType', { unique: false });
        txStore.createIndex('closedDayId', 'closedDayId', { unique: false });
      } else if (oldVersion < 2) {
        // Migrate old 'sales' to 'transactions' with new fields
        const txStore = e.currentTarget.transaction.objectStore('transactions');
        if (!txStore.indexNames.contains('businessDate')) {
          txStore.createIndex('businessDate', 'businessDate', { unique: false });
        }
        if (!txStore.indexNames.contains('paymentType')) {
          txStore.createIndex('paymentType', 'paymentType', { unique: false });
        }
        if (!txStore.indexNames.contains('closedDayId')) {
          txStore.createIndex('closedDayId', 'closedDayId', { unique: false });
        }
      }
      
      // Store 3: Closed Days (NEW)
      if (!database.objectStoreNames.contains('closedDays')) {
        const closedDaysStore = database.createObjectStore('closedDays', { keyPath: 'id', autoIncrement: true });
        closedDaysStore.createIndex('businessDate', 'businessDate', { unique: true });
        closedDaysStore.createIndex('closedAt', 'closedAt', { unique: false });
      }
      
      // Store 4: Settings (NEW)
      if (!database.objectStoreNames.contains('settings')) {
        const settingsStore = database.createObjectStore('settings', { keyPath: 'key' });
      }
    };
  });
}

function getProduct(barcode) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['products'], 'readonly');
    const store = transaction.objectStore('products');
    const request = store.get(barcode);
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

function addProduct(product) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['products'], 'readwrite');
    const store = transaction.objectStore('products');
    const request = store.put(product);
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

// ========================================
// BUSINESS DAY LOGIC
// ========================================

function getCurrentBusinessDate() {
  // Get current active business date from localStorage
  const stored = localStorage.getItem('currentBusinessDate');
  
  if (stored) {
    return stored;
  }
  
  // Create new business date (today)
  const today = getTodayDateStr();
  localStorage.setItem('currentBusinessDate', today);
  return today;
}

function clearCurrentBusinessDate() {
  localStorage.removeItem('currentBusinessDate');
}

async function isBusinessDateClosed(dateStr) {
  const closedDay = await getClosedDayByDate(dateStr);
  return closedDay !== null;
}

// ========================================
// TRANSACTIONS (formerly 'sales')
// ========================================

function saveTransaction(transaction) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(['transactions'], 'readwrite');
    const store = tx.objectStore('transactions');
    const request = store.add(transaction);
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

function getTransactionsByBusinessDate(dateStr) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['transactions'], 'readonly');
    const store = transaction.objectStore('transactions');
    const index = store.index('businessDate');
    const request = index.getAll(dateStr);
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

function getAllTransactions() {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['transactions'], 'readonly');
    const store = transaction.objectStore('transactions');
    const request = store.getAll();
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

function updateTransaction(id, updates) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['transactions'], 'readwrite');
    const store = transaction.objectStore('transactions');
    const getRequest = store.get(id);
    
    getRequest.onsuccess = () => {
      const record = getRequest.result;
      Object.assign(record, updates);
      const updateRequest = store.put(record);
      updateRequest.onsuccess = () => resolve(record);
      updateRequest.onerror = () => reject(updateRequest.error);
    };
    getRequest.onerror = () => reject(getRequest.error);
  });
}

// ========================================
// CLOSED DAYS
// ========================================

function saveClosedDay(closedDay) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['closedDays'], 'readwrite');
    const store = transaction.objectStore('closedDays');
    const request = store.add(closedDay);
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

function getClosedDayByDate(dateStr) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['closedDays'], 'readonly');
    const store = transaction.objectStore('closedDays');
    const index = store.index('businessDate');
    const request = index.get(dateStr);
    
    request.onsuccess = () => resolve(request.result || null);
    request.onerror = () => reject(request.error);
  });
}

function getAllClosedDays() {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['closedDays'], 'readonly');
    const store = transaction.objectStore('closedDays');
    const request = store.getAll();
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

// ========================================
// SETTINGS
// ========================================

function getSetting(key) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['settings'], 'readonly');
    const store = transaction.objectStore('settings');
    const request = store.get(key);
    
    request.onsuccess = () => resolve(request.result?.value || null);
    request.onerror = () => reject(request.error);
  });
}

function setSetting(key, value) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['settings'], 'readwrite');
    const store = transaction.objectStore('settings');
    const request = store.put({ key, value });
    
    request.onsuccess = () => resolve(value);
    request.onerror = () => reject(request.error);
  });
}

// Seed sample products
async function seedProducts() {
  const samples = [
    { barcode: '8690504078006', name: 'Coca Cola 1L', price: 15.00, stock: 100 },
    { barcode: '5449000000996', name: 'Fanta 1L', price: 14.00, stock: 50 },
    { barcode: '8690504078013', name: 'Coca Cola 2.5L', price: 35.00, stock: 30 },
    { barcode: '8690504001015', name: 'Sprite 1L', price: 14.00, stock: 40 },
    { barcode: '8690632007076', name: 'Ãœlker Ã‡ikolata', price: 8.50, stock: 200 }
  ];
  
  for (const product of samples) {
    const exists = await getProduct(product.barcode);
    if (!exists) await addProduct(product);
  }
}

// ========================================
// UTILITY FUNCTIONS
// ========================================
function getTodayDateStr() {
  const today = new Date();
  return today.toISOString().split('T')[0]; // YYYY-MM-DD
}

function getYesterdayDateStr() {
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  return yesterday.toISOString().split('T')[0];
}

function formatTurkishDate(dateStr) {
  const date = new Date(dateStr);
  const months = ['Ocak', 'Åžubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 
                  'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];
  return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
}

// ========================================
// STATE
// ========================================
let cart = [];
let scanLocked = false;
let codeReader = null;
let pendingSaleTotal = 0; // For payment modal
let cashCounts = { 200: 0, 100: 0, 50: 0, 20: 0, coins: 0 };

// ========================================
// UI ELEMENTS
// ========================================
const video = document.getElementById('camera');
const status = document.getElementById('status');
const toast = document.getElementById('toast');
const cartBtn = document.getElementById('cartBtn');
const cartBadge = document.getElementById('cartBadge');
const summaryBtn = document.getElementById('summaryBtn');
const cartModal = document.getElementById('cartModal');
const summaryModal = document.getElementById('summaryModal');
const closeCart = document.getElementById('closeCart');
const closeSummary = document.getElementById('closeSummary');
const cartContent = document.getElementById('cartContent');
const summaryContent = document.getElementById('summaryContent');
const totalPrice = document.getElementById('totalPrice');
const checkoutBtn = document.getElementById('checkoutBtn');
const manualBtn = document.getElementById('manualBtn');
const inputModal = document.getElementById('inputModal');
const barcodeInput = document.getElementById('barcodeInput');
const cancelInput = document.getElementById('cancelInput');
const addManual = document.getElementById('addManual');
const quickAddModal = document.getElementById('quickAddModal');
const quickBarcode = document.getElementById('quickBarcode');
const quickPrice = document.getElementById('quickPrice');
const quickName = document.getElementById('quickName');
const cancelQuickAdd = document.getElementById('cancelQuickAdd');
const saveQuickAdd = document.getElementById('saveQuickAdd');

// Payment modal elements
const paymentModal = document.getElementById('paymentModal');
const paymentTotal = document.getElementById('paymentTotal');
const paymentCash = document.getElementById('paymentCash');
const paymentCard = document.getElementById('paymentCard');
const cancelPayment = document.getElementById('cancelPayment');

// ========================================
// UI FUNCTIONS
// ========================================
function showToast(message, type = 'success') {
  toast.textContent = message;
  toast.className = `toast show ${type}`;
  setTimeout(() => toast.classList.remove('show'), 2000);
}

function vibrate() {
  if (navigator.vibrate) navigator.vibrate(50);
}

function updateCartUI() {
  cartBadge.textContent = cart.length;
  
  if (cart.length === 0) {
    cartContent.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ðŸ›’</div>
        <div>Sepet boÅŸ</div>
      </div>
    `;
    totalPrice.textContent = 'â‚º0.00';
    checkoutBtn.disabled = true;
    return;
  }
  
  cartContent.innerHTML = cart.map((item, index) => `
    <div class="cart-item">
      <div class="item-info">
        <div class="item-name">${item.name}</div>
        <div class="item-code">${item.barcode}</div>
      </div>
      <div class="item-price">â‚º${item.price.toFixed(2)}</div>
      <button class="remove-btn" onclick="removeFromCart(${index})">Ã—</button>
    </div>
  `).join('');
  
  const total = cart.reduce((sum, item) => sum + item.price, 0);
  totalPrice.textContent = `â‚º${total.toFixed(2)}`;
  checkoutBtn.disabled = false;
}

function removeFromCart(index) {
  cart.splice(index, 1);
  updateCartUI();
  vibrate();
}

// ========================================
// DAILY SUMMARY FUNCTIONS
// ========================================
async function renderDailySummary() {
  const today = getTodayDateStr();
  const yesterday = getYesterdayDateStr();
  
  const todaySales = await getSalesByDate(today);
  const yesterdaySales = await getSalesByDate(yesterday);
  
  // Calculate today's stats
  const todayTotal = todaySales.reduce((sum, sale) => sum + sale.total, 0);
  const todayCount = todaySales.length;
  
  // Calculate cash and card totals (payment type based)
  const todayCashTotal = todaySales
    .filter(s => s.paymentType === 'cash')
    .reduce((sum, sale) => sum + sale.total, 0);
  const todayCardTotal = todaySales
    .filter(s => s.paymentType === 'card')
    .reduce((sum, sale) => sum + sale.total, 0);
  
  // Calculate yesterday's total for comparison
  const yesterdayTotal = yesterdaySales.reduce((sum, sale) => sum + sale.total, 0);
  
  // Calculate comparison
  let comparison = '';
  if (yesterdayTotal > 0) {
    const diff = ((todayTotal - yesterdayTotal) / yesterdayTotal * 100).toFixed(0);
    if (diff > 0) {
      comparison = `<span class="comparison positive">â†‘ %${diff}</span>`;
    } else if (diff < 0) {
      comparison = `<span class="comparison negative">â†“ %${Math.abs(diff)}</span>`;
    } else {
      comparison = `<span class="stat-value">-</span>`;
    }
  }
  
  summaryContent.innerHTML = `
    <div class="summary-hero">
      <div class="summary-date">${formatTurkishDate(today)}</div>
      <div class="summary-amount">â‚º${todayTotal.toFixed(2)}</div>
      <div class="summary-count">${todayCount} satÄ±ÅŸ</div>
    </div>
    
    <div class="summary-section">
      <div class="section-title">ðŸ’³ Ã–deme DaÄŸÄ±lÄ±mÄ±</div>
      
      <div class="stat-row">
        <span class="stat-label">Nakit satÄ±ÅŸlar</span>
        <span class="stat-value">â‚º${todayCashTotal.toFixed(2)}</span>
      </div>
      
      <div class="stat-row">
        <span class="stat-label">Kart satÄ±ÅŸlar</span>
        <span class="stat-value">â‚º${todayCardTotal.toFixed(2)}</span>
      </div>
    </div>
    
    <div class="summary-section">
      <div class="section-title">ðŸ’µ Kasa KontrolÃ¼</div>
      
      <div class="stat-row" style="margin-bottom: 16px;">
        <span class="stat-label" style="font-weight: 600;">POS Nakit</span>
        <span class="stat-value" style="font-size: 18px; color: #00ff88;">â‚º${todayCashTotal.toFixed(2)}</span>
      </div>
      
      <div style="margin-bottom: 12px;">
        <label style="display: block; font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 8px;">
          Kasa SayÄ±lan Tutar
        </label>
        <input 
          type="number" 
          id="countedCash" 
          class="input-field" 
          placeholder="0.00" 
          step="0.01"
          inputmode="decimal"
          style="height: 56px; font-size: 18px; text-align: center; font-weight: 600;"
        >
      </div>
      
      <div class="difference-row" id="differenceRow" style="display: none;">
        <span style="font-weight: 600;">Fark</span>
        <span id="cashDifference" class="difference-positive" style="font-size: 18px; font-weight: 700;">â‚º0.00</span>
      </div>
    </div>
    
    <div class="summary-section">
      <div class="section-title">ðŸ“Š KarÅŸÄ±laÅŸtÄ±rma</div>
      
      <div class="stat-row">
        <span class="stat-label">DÃ¼nkÃ¼ ciro</span>
        <span class="stat-value">â‚º${yesterdayTotal.toFixed(2)} ${comparison}</span>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="action-btn btn-primary" onclick="closeDaySummary()">
        âœ“ GÃ¼nÃ¼ Kapat
      </button>
      <button class="action-btn btn-secondary" onclick="returnToScanner()">
        Yeni SatÄ±ÅŸ
      </button>
    </div>
  `;
  
  // Attach cash counting event listener
  const countedInput = document.getElementById('countedCash');
  if (countedInput) {
    countedInput.addEventListener('input', () => updateSimpleCashCount(todayCashTotal));
    countedInput.focus();
  }
}

// Simple cash reconciliation - just compare POS cash vs counted cash
function updateSimpleCashCount(posCashTotal) {
  const countedCash = parseFloat(document.getElementById('countedCash').value) || 0;
  const diffRow = document.getElementById('differenceRow');
  const diffElement = document.getElementById('cashDifference');
  
  // Only show difference if user entered something
  if (countedCash > 0) {
    diffRow.style.display = 'flex';
    
    const diff = countedCash - posCashTotal;
    
    if (Math.abs(diff) < 0.01) {
      // Perfect match
      diffElement.textContent = 'âœ“ Tam';
      diffElement.className = 'difference-positive';
    } else if (diff > 0) {
      // Extra cash
      diffElement.textContent = `+â‚º${diff.toFixed(2)}`;
      diffElement.className = 'difference-positive';
    } else {
      // Cash shortage
      diffElement.textContent = `â‚º${diff.toFixed(2)}`;
      diffElement.className = 'difference-negative';
    }
  } else {
    diffRow.style.display = 'none';
  }
}

function closeDaySummary() {
  const countedCash = parseFloat(document.getElementById('countedCash')?.value) || 0;
  
  if (countedCash === 0) {
    if (!confirm('Kasa sayÄ±mÄ± yapÄ±lmadÄ±.\n\nYine de gÃ¼nÃ¼ kapatmak istiyor musunuz?')) {
      return;
    }
  }
  
  if (confirm('GÃ¼nÃ¼ kapatmak istediÄŸinize emin misiniz?\n\nBu iÅŸlem geri alÄ±namaz.')) {
    // Save day closing info to localStorage
    const today = getTodayDateStr();
    const closingInfo = {
      date: today,
      timestamp: new Date().toISOString(),
      countedCash: countedCash
    };
    
    localStorage.setItem(`day_closed_${today}`, JSON.stringify(closingInfo));
    
    showToast('âœ“ GÃ¼n kapatÄ±ldÄ±', 'success');
    summaryModal.classList.remove('show');
    resumeScanner();
  }
}

function returnToScanner() {
  summaryModal.classList.remove('show');
  resumeScanner();
  showToast('Yeni satÄ±ÅŸ iÃ§in hazÄ±r', 'success');
}

function closeSummaryModal() {
  summaryModal.classList.remove('show');
  resumeScanner();
}

// ========================================
// SCANNING LOGIC
// ========================================
async function handleBarcode(barcode) {
  if (scanLocked) return;
  scanLocked = true;
  
  try {
    let product = await getProduct(barcode);
    
    if (product) {
      // Product exists - add to cart immediately
      cart.push({ ...product });
      showToast(`âœ“ ${product.name} - â‚º${product.price.toFixed(2)}`, 'success');
      vibrate();
      updateCartUI();
      
      // Resume scanning after delay
      setTimeout(() => scanLocked = false, 1000);
    } else {
      // Product NOT found - open Quick Add modal
      pauseScanner();
      openQuickAddModal(barcode);
      scanLocked = false;
    }
    
  } catch (err) {
    console.error('Scan error:', err);
    showToast('Hata oluÅŸtu', 'warning');
    setTimeout(() => scanLocked = false, 1000);
  }
}

function pauseScanner() {
  if (codeReader) {
    codeReader.reset();
  }
}

function resumeScanner() {
  startScanner();
}

// ========================================
// CAMERA SCANNER
// ========================================
async function startScanner() {
  try {
    status.textContent = 'BaÅŸlatÄ±lÄ±yor...';
    
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: 'environment',
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    });
    
    video.srcObject = stream;
    
    codeReader = new ZXing.BrowserMultiFormatReader();
    
    codeReader.decodeFromVideoDevice(
      undefined,
      video,
      (result, err) => {
        if (result) {
          handleBarcode(result.text);
        }
      }
    );
    
    status.textContent = 'HazÄ±r';
    
  } catch (err) {
    console.error('Camera error:', err);
    status.textContent = 'Kamera hatasÄ±';
    showToast('Kamera aÃ§Ä±lamadÄ±', 'warning');
  }
}

// ========================================
// MANUAL BARCODE INPUT
// ========================================
manualBtn.onclick = () => {
  pauseScanner();
  inputModal.classList.add('show');
  barcodeInput.value = '';
  barcodeInput.focus();
};

cancelInput.onclick = () => {
  inputModal.classList.remove('show');
  resumeScanner();
};

addManual.onclick = () => {
  const barcode = barcodeInput.value.trim();
  if (barcode) {
    inputModal.classList.remove('show');
    handleBarcode(barcode);
    resumeScanner();
  }
};

barcodeInput.onkeypress = (e) => {
  if (e.key === 'Enter') addManual.click();
};

// ========================================
// QUICK ADD PRODUCT MODAL
// ========================================
function openQuickAddModal(barcode) {
  quickBarcode.value = barcode;
  quickPrice.value = '';
  quickName.value = '';
  quickAddModal.classList.add('show');
  
  setTimeout(() => quickPrice.focus(), 300);
}

function closeQuickAddModal() {
  quickAddModal.classList.remove('show');
  resumeScanner();
}

cancelQuickAdd.onclick = () => {
  closeQuickAddModal();
  showToast('Ä°ptal edildi', 'warning');
};

saveQuickAdd.onclick = async () => {
  const barcode = quickBarcode.value.trim();
  const price = parseFloat(quickPrice.value);
  const name = quickName.value.trim();
  
  if (!price || price <= 0) {
    quickPrice.classList.add('error');
    showToast('Fiyat girilmeli', 'warning');
    quickPrice.focus();
    return;
  }
  
  quickPrice.classList.remove('error');
  
  const newProduct = {
    barcode: barcode,
    name: name || `ÃœrÃ¼n ${barcode.slice(-4)}`,
    price: price,
    stock: 999
  };
  
  try {
    await addProduct(newProduct);
    cart.push({ ...newProduct });
    updateCartUI();
    closeQuickAddModal();
    showToast(`âœ“ ${newProduct.name} eklendi`, 'success');
    vibrate();
  } catch (err) {
    console.error('Quick add error:', err);
    showToast('KayÄ±t hatasÄ±', 'warning');
  }
};

quickPrice.onkeypress = (e) => {
  if (e.key === 'Enter') quickName.focus();
};

quickName.onkeypress = (e) => {
  if (e.key === 'Enter') saveQuickAdd.click();
};

// ========================================
// CART MODAL
// ========================================
cartBtn.onclick = () => {
  pauseScanner();
  cartModal.classList.add('show');
};

closeCart.onclick = () => {
  cartModal.classList.remove('show');
  resumeScanner();
};

checkoutBtn.onclick = () => {
  if (cart.length === 0) return;
  
  const total = cart.reduce((sum, item) => sum + item.price, 0);
  const itemCount = cart.length;
  
  // Store pending sale info
  pendingSaleTotal = total;
  
  // Show payment modal
  paymentTotal.textContent = `â‚º${total.toFixed(2)}`;
  paymentModal.classList.add('show');
};

// ========================================
// PAYMENT MODAL HANDLERS
// ========================================
cancelPayment.onclick = () => {
  paymentModal.classList.remove('show');
};

paymentCash.onclick = () => {
  completeSale('cash');
};

paymentCard.onclick = () => {
  completeSale('card');
};

async function completeSale(paymentType) {
  if (cart.length === 0) return;
  
  const total = cart.reduce((sum, item) => sum + item.price, 0);
  const itemCount = cart.length;
  
  // Create transaction with all required fields
  const transaction = {
    businessDate: getCurrentBusinessDate(),
    timestamp: new Date().toISOString(),
    paymentType: paymentType,
    items: [...cart],
    total: total,
    itemCount: itemCount,
    closedDayId: null  // Will be set when day is closed
  };
  
  try {
    await saveTransaction(transaction);
    
    // Clear cart
    cart = [];
    updateCartUI();
    
    // Close modals
    paymentModal.classList.remove('show');
    cartModal.classList.remove('show');
    
    // Show success
    const paymentLabel = paymentType === 'cash' ? 'Nakit' : 'Kart';
    showToast(`âœ“ SatÄ±ÅŸ tamamlandÄ± (${paymentLabel})`, 'success');
    vibrate();
    
    // Resume scanner
    resumeScanner();
    
  } catch (err) {
    console.error('Save transaction error:', err);
    showToast('SatÄ±ÅŸ kaydedilemedi', 'warning');
  }
}

// ========================================
// DAILY SUMMARY MODAL
// ========================================
summaryBtn.onclick = async () => {
  pauseScanner();
  summaryModal.classList.add('show');
  await renderDailySummary();
};

closeSummary.onclick = () => {
  summaryModal.classList.remove('show');
  resumeScanner();
};

// ========================================
// INIT
// ========================================
(async function init() {
  await initDB();
  await seedProducts();
  await startScanner();
  updateCartUI();
})();

// Expose for inline handlers
window.removeFromCart = removeFromCart;
window.closeDaySummary = closeDaySummary;
window.closeSummaryModal = closeSummaryModal;
window.returnToScanner = returnToScanner;
</script>

</body>
</html>
