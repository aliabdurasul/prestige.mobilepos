<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Prestige.POS</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

body {
  background: #000;
  color: #fff;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  overflow: hidden;
  height: 100vh;
  height: 100dvh;
  touch-action: pan-y;
}

/* CAMERA */
#camera {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: 1;
}

/* TOP BAR */
.top-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 56px;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  z-index: 100;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.logo {
  font-size: 18px;
  font-weight: 700;
  letter-spacing: -0.5px;
}

.status-badge {
  font-size: 11px;
  padding: 4px 10px;
  background: rgba(0,255,136,0.15);
  color: #00ff88;
  border-radius: 12px;
  font-weight: 600;
}

/* SCAN AREA */
.scan-area {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 85%;
  max-width: 340px;
  aspect-ratio: 16/9;
  z-index: 10;
}

.scan-frame {
  position: relative;
  width: 100%;
  height: 100%;
  border: 2px solid #00ff88;
  border-radius: 16px;
  box-shadow: 0 0 0 2px rgba(0,0,0,0.3), 0 0 40px rgba(0,255,136,0.4);
}

.corner {
  position: absolute;
  width: 20px;
  height: 20px;
  border: 3px solid #00ff88;
}

.corner.tl { top: -2px; left: -2px; border-right: 0; border-bottom: 0; border-radius: 16px 0 0 0; }
.corner.tr { top: -2px; right: -2px; border-left: 0; border-bottom: 0; border-radius: 0 16px 0 0; }
.corner.bl { bottom: -2px; left: -2px; border-right: 0; border-top: 0; border-radius: 0 0 0 16px; }
.corner.br { bottom: -2px; right: -2px; border-left: 0; border-top: 0; border-radius: 0 0 16px 0; }

.scan-line {
  position: absolute;
  left: 10%;
  right: 10%;
  height: 2px;
  background: linear-gradient(90deg, transparent, #00ff88, transparent);
  box-shadow: 0 0 10px #00ff88;
  animation: scan 2s ease-in-out infinite;
}

@keyframes scan {
  0%, 100% { top: 10%; opacity: 0; }
  50% { top: 50%; opacity: 1; }
  100% { top: 90%; opacity: 0; }
}

.scan-hint {
  position: absolute;
  bottom: -40px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 13px;
  color: rgba(255,255,255,0.7);
  white-space: nowrap;
}

/* FEEDBACK TOAST */
.toast {
  position: fixed;
  top: 72px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  padding: 14px 20px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
  z-index: 200;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
  max-width: 85%;
  text-align: center;
  border: 1px solid rgba(0,255,136,0.3);
}

.toast.show { opacity: 1; }
.toast.success { background: rgba(0,255,136,0.2); border-color: #00ff88; }
.toast.warning { background: rgba(255,159,10,0.2); border-color: #ff9f0a; }

/* BOTTOM BAR */
.bottom-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  padding: 12px 16px calc(12px + env(safe-area-inset-bottom));
  z-index: 100;
  border-top: 1px solid rgba(255,255,255,0.1);
}

.bottom-buttons {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
}

.cart-btn {
  flex: 2;
  height: 54px;
  background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
  border: none;
  border-radius: 14px;
  font-size: 17px;
  font-weight: 700;
  color: #000;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  box-shadow: 0 4px 20px rgba(0,255,136,0.3);
  transition: transform 0.1s;
}

.cart-btn:active { transform: scale(0.97); }

.summary-btn {
  flex: 1;
  height: 54px;
  background: rgba(255,159,10,0.2);
  border: 1px solid rgba(255,159,10,0.4);
  border-radius: 14px;
  font-size: 15px;
  font-weight: 700;
  color: #ff9f0a;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.1s;
}

.summary-btn:active { transform: scale(0.97); }

.cart-badge {
  background: rgba(0,0,0,0.3);
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 15px;
}

.manual-btn {
  width: 100%;
  height: 44px;
  background: transparent;
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  color: rgba(255,255,255,0.7);
}

.manual-btn:active { background: rgba(255,255,255,0.05); }

/* CART MODAL */
.modal {
  position: fixed;
  inset: 0;
  background: #000;
  z-index: 300;
  display: none;
  flex-direction: column;
}

.modal.show { display: flex; }

.modal-header {
  height: 56px;
  background: rgba(0,0,0,0.95);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.modal-title {
  font-size: 18px;
  font-weight: 700;
}

.close-btn {
  width: 32px;
  height: 32px;
  background: rgba(255,255,255,0.1);
  border: none;
  border-radius: 8px;
  color: #fff;
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-content {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}

.cart-item {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.item-info {
  flex: 1;
  min-width: 0;
}

.item-name {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 4px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.item-code {
  font-size: 12px;
  color: rgba(255,255,255,0.5);
}

.item-price {
  font-size: 18px;
  font-weight: 700;
  color: #00ff88;
  margin-left: 12px;
}

.remove-btn {
  width: 32px;
  height: 32px;
  background: rgba(255,59,48,0.15);
  border: 1px solid rgba(255,59,48,0.3);
  border-radius: 8px;
  color: #ff3b30;
  font-size: 18px;
  margin-left: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: rgba(255,255,255,0.4);
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.modal-footer {
  background: rgba(0,0,0,0.95);
  padding: 16px 16px calc(16px + env(safe-area-inset-bottom));
  border-top: 1px solid rgba(255,255,255,0.1);
}

.total-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  font-size: 20px;
  font-weight: 700;
}

.total-price {
  color: #00ff88;
}

.checkout-btn {
  width: 100%;
  height: 54px;
  background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
  border: none;
  border-radius: 14px;
  font-size: 17px;
  font-weight: 700;
  color: #000;
}

.checkout-btn:disabled {
  opacity: 0.5;
  background: rgba(255,255,255,0.1);
  color: rgba(255,255,255,0.3);
}

/* DAILY SUMMARY STYLES */
.summary-hero {
  background: linear-gradient(135deg, rgba(0,255,136,0.15) 0%, rgba(0,204,106,0.1) 100%);
  border: 1px solid rgba(0,255,136,0.2);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 20px;
  text-align: center;
}

.summary-date {
  font-size: 13px;
  color: rgba(255,255,255,0.5);
  margin-bottom: 8px;
}

.summary-amount {
  font-size: 48px;
  font-weight: 700;
  color: #00ff88;
  margin-bottom: 8px;
}

.summary-count {
  font-size: 15px;
  color: rgba(255,255,255,0.7);
}

.summary-section {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
}

.section-title {
  font-size: 14px;
  font-weight: 600;
  color: rgba(255,255,255,0.7);
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.cash-row {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 10px;
}

.cash-label {
  font-size: 16px;
  font-weight: 600;
  min-width: 60px;
}

.cash-input {
  flex: 1;
  height: 40px;
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 8px;
  padding: 0 12px;
  color: #fff;
  font-size: 16px;
  text-align: center;
}

.cash-input:focus {
  outline: none;
  border-color: #00ff88;
}

.cash-result {
  font-size: 16px;
  font-weight: 600;
  min-width: 80px;
  text-align: right;
  color: #00ff88;
}

.cash-total {
  display: flex;
  justify-content: space-between;
  padding-top: 12px;
  margin-top: 12px;
  border-top: 1px solid rgba(255,255,255,0.1);
  font-size: 18px;
  font-weight: 700;
}

.difference-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: rgba(255,255,255,0.03);
  border-radius: 8px;
  margin-top: 12px;
}

.difference-positive {
  color: #00ff88;
}

.difference-negative {
  color: #ff3b30;
}

.stat-row {
  display: flex;
  justify-content: space-between;
  padding: 10px 0;
  font-size: 15px;
}

.stat-label {
  color: rgba(255,255,255,0.6);
}

.stat-value {
  font-weight: 600;
}

.comparison {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  margin-left: 8px;
}

.comparison.positive {
  background: rgba(0,255,136,0.15);
  color: #00ff88;
}

.comparison.negative {
  background: rgba(255,59,48,0.15);
  color: #ff3b30;
}

.action-btn {
  width: 100%;
  height: 50px;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 10px;
}

.btn-primary {
  background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
  color: #000;
}

.btn-secondary {
  background: rgba(255,255,255,0.1);
  color: #fff;
}

/* MANUAL INPUT MODAL */
.input-modal {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0,0,0,0.98);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  padding: 24px 16px calc(24px + env(safe-area-inset-bottom));
  border-radius: 20px 20px 0 0;
  z-index: 400;
  transform: translateY(100%);
  transition: transform 0.3s;
}

.input-modal.show { transform: translateY(0); }

.input-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 8px;
}

.input-subtitle {
  font-size: 13px;
  color: rgba(255,255,255,0.5);
  margin-bottom: 20px;
}

.input-group {
  margin-bottom: 16px;
}

.input-label {
  font-size: 13px;
  color: rgba(255,255,255,0.7);
  margin-bottom: 8px;
  display: block;
}

.input-label .required {
  color: #ff3b30;
}

.input-field {
  width: 100%;
  height: 50px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 12px;
  padding: 0 16px;
  color: #fff;
  font-size: 16px;
}

.input-field:focus {
  outline: none;
  border-color: #00ff88;
  background: rgba(255,255,255,0.08);
}

.input-field:disabled {
  opacity: 0.5;
  background: rgba(255,255,255,0.02);
}

.input-field.error {
  border-color: #ff3b30;
}

.btn-group {
  display: flex;
  gap: 12px;
  margin-top: 20px;
}

.btn-cancel, .btn-add {
  flex: 1;
  height: 50px;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
}

.btn-cancel {
  background: rgba(255,255,255,0.1);
  color: #fff;
}

.btn-add {
  background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
  color: #000;
}

.btn-add:disabled {
  opacity: 0.4;
  background: rgba(255,255,255,0.1);
}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="top-bar">
  <div class="logo">Prestige.POS</div>
  <div class="status-badge" id="status">Hazƒ±r</div>
</div>

<!-- CAMERA -->
<video id="camera" autoplay playsinline muted></video>

<!-- SCAN AREA -->
<div class="scan-area">
  <div class="scan-frame">
    <div class="corner tl"></div>
    <div class="corner tr"></div>
    <div class="corner bl"></div>
    <div class="corner br"></div>
    <div class="scan-line"></div>
  </div>
  <div class="scan-hint">Barkodu kameraya tutun</div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- BOTTOM BAR -->
<div class="bottom-bar">
  <div class="bottom-buttons">
    <button class="cart-btn" id="cartBtn">
      üõí Sepet
      <span class="cart-badge" id="cartBadge">0</span>
    </button>
    <button class="summary-btn" id="summaryBtn">
      üìä<br>G√ºn Sonu
    </button>
  </div>
  <button class="manual-btn" id="manualBtn">Manuel Barkod Gir</button>
</div>

<!-- CART MODAL -->
<div class="modal" id="cartModal">
  <div class="modal-header">
    <div class="modal-title">Sepet</div>
    <button class="close-btn" id="closeCart">√ó</button>
  </div>
  <div class="modal-content" id="cartContent"></div>
  <div class="modal-footer">
    <div class="total-row">
      <span>Toplam</span>
      <span class="total-price" id="totalPrice">‚Ç∫0.00</span>
    </div>
    <button class="checkout-btn" id="checkoutBtn">√ñdeme Al</button>
  </div>
</div>

<!-- DAILY SUMMARY MODAL -->
<div class="modal" id="summaryModal">
  <div class="modal-header">
    <div class="modal-title">G√ºn Sonu</div>
    <button class="close-btn" id="closeSummary">√ó</button>
  </div>
  <div class="modal-content" id="summaryContent">
    <!-- Content populated by JS -->
  </div>
</div>

<!-- RECEIPT QR MODAL -->
<div class="modal" id="receiptModal">
  <div class="modal-header">
    <div class="modal-title">Fi≈ü</div>
    <button class="close-btn" id="closeReceipt">√ó</button>
  </div>
  <div class="modal-content" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px;">
    <div style="background: #fff; padding: 20px; border-radius: 16px; margin-bottom: 20px;">
      <canvas id="qrCanvas" style="display: block;"></canvas>
    </div>
    <div style="text-align: center; color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 20px;">
      M√º≈üteri bu QR'ƒ± taratabilir
    </div>
    <div id="receiptAmount" style="font-size: 32px; font-weight: 700; color: #00ff88; margin-bottom: 10px;">‚Ç∫0.00</div>
    <div id="receiptPayment" style="font-size: 16px; color: rgba(255,255,255,0.7);">Nakit</div>
  </div>
  <div class="modal-footer">
    <button class="action-btn btn-primary" onclick="closeReceiptModal()">
      Kapat
    </button>
  </div>
</div>

<!-- MANUAL BARCODE MODAL -->
<div class="input-modal" id="inputModal">
  <div class="input-title">Manuel Barkod</div>
  <div class="input-subtitle">Barkod numarasƒ±nƒ± girin</div>
  <div class="input-group">
    <input type="tel" class="input-field" id="barcodeInput" placeholder="Barkod numarasƒ±" autofocus>
  </div>
  <div class="btn-group">
    <button class="btn-cancel" id="cancelInput">ƒ∞ptal</button>
    <button class="btn-add" id="addManual">Tara</button>
  </div>
</div>

<!-- PAYMENT SELECTION MODAL -->
<div class="input-modal" id="paymentModal">
  <div class="input-title">√ñdeme ≈ûekli</div>
  <div class="input-subtitle" id="paymentTotal">‚Ç∫0.00</div>
  
  <button class="action-btn btn-primary" id="paymentCash" style="margin-bottom: 12px;">
    üíµ Nakit
  </button>
  
  <button class="action-btn btn-primary" id="paymentCard" style="margin-bottom: 12px;">
    üí≥ Kart
  </button>
  
  <button class="action-btn btn-secondary" id="cancelPayment">
    ƒ∞ptal
  </button>
</div>

<!-- QUICK ADD PRODUCT MODAL -->
<div class="input-modal" id="quickAddModal">
  <div class="input-title">√úr√ºn Bulunamadƒ±</div>
  <div class="input-subtitle">Hƒ±zlƒ± √ºr√ºn ekle</div>
  
  <div class="input-group">
    <label class="input-label">Barkod</label>
    <input type="text" class="input-field" id="quickBarcode" disabled>
  </div>
  
  <div class="input-group">
    <label class="input-label">Fiyat <span class="required">*</span></label>
    <input type="number" step="0.01" class="input-field" id="quickPrice" placeholder="0.00" inputmode="decimal" autofocus>
  </div>
  
  <div class="input-group">
    <label class="input-label">√úr√ºn Adƒ± (opsiyonel)</label>
    <input type="text" class="input-field" id="quickName" placeholder="√úr√ºn adƒ± girebilirsiniz">
  </div>
  
  <div class="btn-group">
    <button class="btn-cancel" id="cancelQuickAdd">ƒ∞ptal</button>
    <button class="btn-add" id="saveQuickAdd">Kaydet ve Ekle</button>
  </div>
</div>

<script src="https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
// ========================================
// DATABASE (IndexedDB) - Version 2
// ========================================
const DB_NAME = 'PrestigePOS';
const DB_VERSION = 2;
let db;

function initDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onerror = () => reject(request.error);
    request.onsuccess = () => {
      db = request.result;
      resolve(db);
    };
    
    request.onupgradeneeded = (e) => {
      const database = e.target.result;
      const oldVersion = e.oldVersion;
      
      // Store 1: Products
      if (!database.objectStoreNames.contains('products')) {
        const productStore = database.createObjectStore('products', { keyPath: 'barcode' });
        productStore.createIndex('name', 'name', { unique: false });
      }
      
      // Store 2: Transactions (renamed from 'sales')
      if (!database.objectStoreNames.contains('transactions')) {
        const txStore = database.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
        txStore.createIndex('businessDate', 'businessDate', { unique: false });
        txStore.createIndex('timestamp', 'timestamp', { unique: false });
        txStore.createIndex('paymentType', 'paymentType', { unique: false });
        txStore.createIndex('closedDayId', 'closedDayId', { unique: false });
      } else if (oldVersion < 2) {
        // Migrate old 'sales' to 'transactions' with new fields
        const txStore = e.currentTarget.transaction.objectStore('transactions');
        if (!txStore.indexNames.contains('businessDate')) {
          txStore.createIndex('businessDate', 'businessDate', { unique: false });
        }
        if (!txStore.indexNames.contains('paymentType')) {
          txStore.createIndex('paymentType', 'paymentType', { unique: false });
        }
        if (!txStore.indexNames.contains('closedDayId')) {
          txStore.createIndex('closedDayId', 'closedDayId', { unique: false });
        }
      }
      
      // Store 3: Closed Days (NEW)
      if (!database.objectStoreNames.contains('closedDays')) {
        const closedDaysStore = database.createObjectStore('closedDays', { keyPath: 'id', autoIncrement: true });
        closedDaysStore.createIndex('businessDate', 'businessDate', { unique: true });
        closedDaysStore.createIndex('closedAt', 'closedAt', { unique: false });
      }
      
      // Store 4: Settings (NEW)
      if (!database.objectStoreNames.contains('settings')) {
        const settingsStore = database.createObjectStore('settings', { keyPath: 'key' });
      }
    };
  });
}

function getProduct(barcode) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['products'], 'readonly');
    const store = transaction.objectStore('products');
    const request = store.get(barcode);
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

function addProduct(product) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['products'], 'readwrite');
    const store = transaction.objectStore('products');
    const request = store.put(product);
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

// ========================================
// BUSINESS DAY LOGIC
// ========================================

function getCurrentBusinessDate() {
  // Get current active business date from localStorage
  const stored = localStorage.getItem('currentBusinessDate');
  
  if (stored) {
    return stored;
  }
  
  // Create new business date (today)
  const today = getTodayDateStr();
  localStorage.setItem('currentBusinessDate', today);
  return today;
}

function clearCurrentBusinessDate() {
  localStorage.removeItem('currentBusinessDate');
}

async function isBusinessDateClosed(dateStr) {
  const closedDay = await getClosedDayByDate(dateStr);
  return closedDay !== null;
}

// ========================================
// TRANSACTIONS (formerly 'sales')
// ========================================

function saveTransaction(transaction) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(['transactions'], 'readwrite');
    const store = tx.objectStore('transactions');
    const request = store.add(transaction);
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

function getTransactionsByBusinessDate(dateStr) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['transactions'], 'readonly');
    const store = transaction.objectStore('transactions');
    const index = store.index('businessDate');
    const request = index.getAll(dateStr);
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

function getAllTransactions() {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['transactions'], 'readonly');
    const store = transaction.objectStore('transactions');
    const request = store.getAll();
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

function updateTransaction(id, updates) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['transactions'], 'readwrite');
    const store = transaction.objectStore('transactions');
    const getRequest = store.get(id);
    
    getRequest.onsuccess = () => {
      const record = getRequest.result;
      Object.assign(record, updates);
      const updateRequest = store.put(record);
      updateRequest.onsuccess = () => resolve(record);
      updateRequest.onerror = () => reject(updateRequest.error);
    };
    getRequest.onerror = () => reject(getRequest.error);
  });
}

// ========================================
// CLOSED DAYS
// ========================================

function saveClosedDay(closedDay) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['closedDays'], 'readwrite');
    const store = transaction.objectStore('closedDays');
    const request = store.add(closedDay);
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

function getClosedDayByDate(dateStr) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['closedDays'], 'readonly');
    const store = transaction.objectStore('closedDays');
    const index = store.index('businessDate');
    const request = index.get(dateStr);
    
    request.onsuccess = () => resolve(request.result || null);
    request.onerror = () => reject(request.error);
  });
}

function getAllClosedDays() {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['closedDays'], 'readonly');
    const store = transaction.objectStore('closedDays');
    const request = store.getAll();
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

// ========================================
// SETTINGS
// ========================================

function getSetting(key) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['settings'], 'readonly');
    const store = transaction.objectStore('settings');
    const request = store.get(key);
    
    request.onsuccess = () => resolve(request.result?.value || null);
    request.onerror = () => reject(request.error);
  });
}

function setSetting(key, value) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['settings'], 'readwrite');
    const store = transaction.objectStore('settings');
    const request = store.put({ key, value });
    
    request.onsuccess = () => resolve(value);
    request.onerror = () => reject(request.error);
  });
}

// Seed sample products
async function seedProducts() {
  const samples = [
    { barcode: '8690504078006', name: 'Coca Cola 1L', price: 15.00, stock: 100 },
    { barcode: '5449000000996', name: 'Fanta 1L', price: 14.00, stock: 50 },
    { barcode: '8690504078013', name: 'Coca Cola 2.5L', price: 35.00, stock: 30 },
    { barcode: '8690504001015', name: 'Sprite 1L', price: 14.00, stock: 40 },
    { barcode: '8690632007076', name: '√úlker √áikolata', price: 8.50, stock: 200 }
  ];
  
  for (const product of samples) {
    const exists = await getProduct(product.barcode);
    if (!exists) await addProduct(product);
  }
}

// ========================================
// UTILITY FUNCTIONS
// ========================================
function getTodayDateStr() {
  const today = new Date();
  return today.toISOString().split('T')[0]; // YYYY-MM-DD
}

function getYesterdayDateStr() {
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  return yesterday.toISOString().split('T')[0];
}

function formatTurkishDate(dateStr) {
  const date = new Date(dateStr);
  const months = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 
                  'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
  return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
}

// ========================================
// STATE
// ========================================
let cart = [];
let scanLocked = false;
let codeReader = null;
let pendingSaleTotal = 0; // For payment modal
let cashCounts = { 200: 0, 100: 0, 50: 0, 20: 0, coins: 0 };

// ========================================
// UI ELEMENTS
// ========================================
const video = document.getElementById('camera');
const status = document.getElementById('status');
const toast = document.getElementById('toast');
const cartBtn = document.getElementById('cartBtn');
const cartBadge = document.getElementById('cartBadge');
const summaryBtn = document.getElementById('summaryBtn');
const cartModal = document.getElementById('cartModal');
const summaryModal = document.getElementById('summaryModal');
const closeCart = document.getElementById('closeCart');
const closeSummary = document.getElementById('closeSummary');
const cartContent = document.getElementById('cartContent');
const summaryContent = document.getElementById('summaryContent');
const totalPrice = document.getElementById('totalPrice');
const checkoutBtn = document.getElementById('checkoutBtn');
const manualBtn = document.getElementById('manualBtn');
const inputModal = document.getElementById('inputModal');
const barcodeInput = document.getElementById('barcodeInput');
const cancelInput = document.getElementById('cancelInput');
const addManual = document.getElementById('addManual');
const quickAddModal = document.getElementById('quickAddModal');
const quickBarcode = document.getElementById('quickBarcode');
const quickPrice = document.getElementById('quickPrice');
const quickName = document.getElementById('quickName');
const cancelQuickAdd = document.getElementById('cancelQuickAdd');
const saveQuickAdd = document.getElementById('saveQuickAdd');

// Payment modal elements
const paymentModal = document.getElementById('paymentModal');
const paymentTotal = document.getElementById('paymentTotal');
const paymentCash = document.getElementById('paymentCash');
const paymentCard = document.getElementById('paymentCard');
const cancelPayment = document.getElementById('cancelPayment');

// Receipt modal elements
const receiptModal = document.getElementById('receiptModal');
const closeReceipt = document.getElementById('closeReceipt');
const qrCanvas = document.getElementById('qrCanvas');
const receiptAmount = document.getElementById('receiptAmount');
const receiptPayment = document.getElementById('receiptPayment');

// ========================================
// UI FUNCTIONS
// ========================================
function showToast(message, type = 'success') {
  toast.textContent = message;
  toast.className = `toast show ${type}`;
  setTimeout(() => toast.classList.remove('show'), 2000);
}

function vibrate() {
  if (navigator.vibrate) navigator.vibrate(50);
}

function updateCartUI() {
  cartBadge.textContent = cart.length;
  
  if (cart.length === 0) {
    cartContent.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üõí</div>
        <div>Sepet bo≈ü</div>
      </div>
    `;
    totalPrice.textContent = '‚Ç∫0.00';
    checkoutBtn.disabled = true;
    return;
  }
  
  cartContent.innerHTML = cart.map((item, index) => `
    <div class="cart-item">
      <div class="item-info">
        <div class="item-name">${item.name}</div>
        <div class="item-code">${item.barcode}</div>
      </div>
      <div class="item-price">‚Ç∫${item.price.toFixed(2)}</div>
      <button class="remove-btn" onclick="removeFromCart(${index})">√ó</button>
    </div>
  `).join('');
  
  const total = cart.reduce((sum, item) => sum + item.price, 0);
  totalPrice.textContent = `‚Ç∫${total.toFixed(2)}`;
  checkoutBtn.disabled = false;
}

function removeFromCart(index) {
  cart.splice(index, 1);
  updateCartUI();
  vibrate();
}

// ========================================
// DAILY SUMMARY FUNCTIONS
// ========================================
async function renderDailySummary() {
  const businessDate = getCurrentBusinessDate();
  const yesterday = getYesterdayDateStr();
  
  // Check if day is already closed
  const isClosed = await isBusinessDateClosed(businessDate);
  
  // Get today's transactions
  const todayTx = await getTransactionsByBusinessDate(businessDate);
  const yesterdayTx = await getTransactionsByBusinessDate(yesterday);
  
  // Calculate today's stats
  const todayTotal = todayTx.reduce((sum, tx) => sum + tx.total, 0);
  const todayCount = todayTx.length;
  
  // Calculate cash and card totals
  const todayCashTotal = todayTx
    .filter(tx => tx.paymentType === 'cash')
    .reduce((sum, tx) => sum + tx.total, 0);
  const todayCardTotal = todayTx
    .filter(tx => tx.paymentType === 'card')
    .reduce((sum, tx) => sum + tx.total, 0);
  
  const todayCashCount = todayTx.filter(tx => tx.paymentType === 'cash').length;
  const todayCardCount = todayTx.filter(tx => tx.paymentType === 'card').length;
  
  // Calculate yesterday's total for comparison
  const yesterdayTotal = yesterdayTx.reduce((sum, tx) => sum + tx.total, 0);
  
  // Calculate comparison
  let comparison = '';
  if (yesterdayTotal > 0) {
    const diff = ((todayTotal - yesterdayTotal) / yesterdayTotal * 100).toFixed(0);
    if (diff > 0) {
      comparison = `<span class="comparison positive">‚Üë %${diff}</span>`;
    } else if (diff < 0) {
      comparison = `<span class="comparison negative">‚Üì %${Math.abs(diff)}</span>`;
    } else {
      comparison = `<span class="stat-value">-</span>`;
    }
  }
  
  // Warning if day already closed
  const closedWarning = isClosed ? 
    `<div style="background: rgba(255,159,10,0.2); border: 1px solid #ff9f0a; border-radius: 12px; padding: 12px; margin-bottom: 16px; text-align: center;">
      ‚ö†Ô∏è Bu g√ºn kapatƒ±lmƒ±≈ü
    </div>` : '';
  
  summaryContent.innerHTML = `
    ${closedWarning}
    
    <div class="summary-hero">
      <div class="summary-date">${formatTurkishDate(businessDate)}</div>
      <div class="summary-amount">‚Ç∫${todayTotal.toFixed(2)}</div>
      <div class="summary-count">${todayCount} satƒ±≈ü</div>
    </div>
    
    <div class="summary-section">
      <div class="section-title">üí≥ √ñdeme Daƒüƒ±lƒ±mƒ±</div>
      
      <div class="stat-row">
        <span class="stat-label">Nakit satƒ±≈ülar</span>
        <span class="stat-value">‚Ç∫${todayCashTotal.toFixed(2)} <span style="color: rgba(255,255,255,0.5);">(${todayCashCount} adet)</span></span>
      </div>
      
      <div class="stat-row">
        <span class="stat-label">Kart satƒ±≈ülar</span>
        <span class="stat-value">‚Ç∫${todayCardTotal.toFixed(2)} <span style="color: rgba(255,255,255,0.5);">(${todayCardCount} adet)</span></span>
      </div>
    </div>
    
    <div class="summary-section">
      <div class="section-title">üíµ Kasa Kontrol√º</div>
      
      <div class="stat-row" style="margin-bottom: 16px;">
        <span class="stat-label" style="font-weight: 600;">POS Nakit</span>
        <span class="stat-value" style="font-size: 18px; color: #00ff88;">‚Ç∫${todayCashTotal.toFixed(2)}</span>
      </div>
      
      <div style="margin-bottom: 12px;">
        <label style="display: block; font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 8px;">
          Kasayƒ± Sayƒ±n
        </label>
        
        <div class="cash-row">
          <div class="cash-label">200‚Ç∫ √ó</div>
          <input type="number" class="cash-input" id="cash200" value="0" min="0" inputmode="numeric">
          <div class="cash-result" id="result200">‚Ç∫0</div>
        </div>
        
        <div class="cash-row">
          <div class="cash-label">100‚Ç∫ √ó</div>
          <input type="number" class="cash-input" id="cash100" value="0" min="0" inputmode="numeric">
          <div class="cash-result" id="result100">‚Ç∫0</div>
        </div>
        
        <div class="cash-row">
          <div class="cash-label">50‚Ç∫ √ó</div>
          <input type="number" class="cash-input" id="cash50" value="0" min="0" inputmode="numeric">
          <div class="cash-result" id="result50">‚Ç∫0</div>
        </div>
        
        <div class="cash-row">
          <div class="cash-label">20‚Ç∫ √ó</div>
          <input type="number" class="cash-input" id="cash20" value="0" min="0" inputmode="numeric">
          <div class="cash-result" id="result20">‚Ç∫0</div>
        </div>
        
        <div class="cash-row">
          <div class="cash-label">Bozuk</div>
          <input type="number" class="cash-input" id="cashCoins" value="0" min="0" step="0.5" inputmode="decimal">
          <div class="cash-result" id="resultCoins">‚Ç∫0</div>
        </div>
        
        <div class="cash-total">
          <span>Toplam Kasa</span>
          <span id="cashTotal">‚Ç∫0.00</span>
        </div>
      </div>
      
      <div class="difference-row" id="differenceRow">
        <span style="font-weight: 600;">Fark</span>
        <span id="cashDifference" class="difference-positive">‚Ç∫0.00</span>
      </div>
    </div>
    
    <div class="summary-section">
      <div class="section-title">üìä Kar≈üƒ±la≈ütƒ±rma</div>
      
      <div class="stat-row">
        <span class="stat-label">D√ºnk√º ciro</span>
        <span class="stat-value">‚Ç∫${yesterdayTotal.toFixed(2)} ${comparison}</span>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="action-btn btn-primary" onclick="closeDaySummary()" ${isClosed ? 'disabled' : ''}>
        ‚úì G√ºn√º Kapat
      </button>
      <button class="action-btn btn-secondary" onclick="returnToScanner()">
        Yeni Satƒ±≈ü
      </button>
    </div>
  `;
  
  // Attach cash counting event listeners
  ['cash200', 'cash100', 'cash50', 'cash20', 'cashCoins'].forEach(id => {
    const input = document.getElementById(id);
    if (input) {
      input.addEventListener('input', () => updateCashCount(todayCashTotal));
    }
  });
  
  // Initialize cash count
  updateCashCount(todayCashTotal);
}

// Bill counting with auto-calculation
function updateCashCount(posCashTotal) {
  const bills200 = parseInt(document.getElementById('cash200')?.value) || 0;
  const bills100 = parseInt(document.getElementById('cash100')?.value) || 0;
  const bills50 = parseInt(document.getElementById('cash50')?.value) || 0;
  const bills20 = parseInt(document.getElementById('cash20')?.value) || 0;
  const coins = parseFloat(document.getElementById('cashCoins')?.value) || 0;
  
  const result200 = bills200 * 200;
  const result100 = bills100 * 100;
  const result50 = bills50 * 50;
  const result20 = bills20 * 20;
  
  document.getElementById('result200').textContent = `‚Ç∫${result200}`;
  document.getElementById('result100').textContent = `‚Ç∫${result100}`;
  document.getElementById('result50').textContent = `‚Ç∫${result50}`;
  document.getElementById('result20').textContent = `‚Ç∫${result20}`;
  document.getElementById('resultCoins').textContent = `‚Ç∫${coins.toFixed(2)}`;
  
  const countedTotal = result200 + result100 + result50 + result20 + coins;
  document.getElementById('cashTotal').textContent = `‚Ç∫${countedTotal.toFixed(2)}`;
  
  // Calculate difference
  const diff = countedTotal - posCashTotal;
  const diffElement = document.getElementById('cashDifference');
  
  if (Math.abs(diff) < 0.01) {
    // Perfect match
    diffElement.textContent = '‚úì Tam';
    diffElement.className = 'difference-positive';
  } else if (diff > 0) {
    // Extra cash
    diffElement.textContent = `+‚Ç∫${diff.toFixed(2)}`;
    diffElement.className = 'difference-positive';
  } else {
    // Shortage
    diffElement.textContent = `‚Ç∫${diff.toFixed(2)}`;
    diffElement.className = 'difference-negative';
  }
  
  // Store values for closing
  window.cashCountData = {
    bills200, bills100, bills50, bills20, coins,
    countedTotal, diff
  };
}

async function closeDaySummary() {
  const businessDate = getCurrentBusinessDate();
  
  // Check if already closed
  const alreadyClosed = await isBusinessDateClosed(businessDate);
  if (alreadyClosed) {
    showToast('Bu g√ºn zaten kapatƒ±lmƒ±≈ü', 'warning');
    return;
  }
  
  // Get cash count data
  const cashData = window.cashCountData || {
    bills200: 0, bills100: 0, bills50: 0, bills20: 0, coins: 0,
    countedTotal: 0, diff: 0
  };
  
  // Get all transactions for this business date
  const transactions = await getTransactionsByBusinessDate(businessDate);
  
  if (transactions.length === 0) {
    if (!confirm('Bug√ºn hi√ß satƒ±≈ü yapƒ±lmadƒ±.\n\nYine de g√ºn√º kapatmak istiyor musunuz?')) {
      return;
    }
  }
  
  // Calculate totals
  const totalSales = transactions.reduce((sum, tx) => sum + tx.total, 0);
  const cashTotal = transactions.filter(tx => tx.paymentType === 'cash')
                                .reduce((sum, tx) => sum + tx.total, 0);
  const cardTotal = transactions.filter(tx => tx.paymentType === 'card')
                                .reduce((sum, tx) => sum + tx.total, 0);
  const transactionCount = transactions.length;
  
  // Check for cash difference
  if (Math.abs(cashData.diff) > 0.01 && cashTotal > 0) {
    const diffMsg = cashData.diff < 0 ? 
      `Kasada eksik var (‚Ç∫${Math.abs(cashData.diff).toFixed(2)})` :
      `Kasada fazla var (+‚Ç∫${cashData.diff.toFixed(2)})`;
    
    if (!confirm(`${diffMsg}\n\nG√ºn√º kapatmak istediƒüinize emin misiniz?`)) {
      return;
    }
  } else {
    if (!confirm('G√ºn√º kapatmak istediƒüinize emin misiniz?\n\nBu i≈ülem geri alƒ±namaz.')) {
      return;
    }
  }
  
  // Create closed day record
  const closedDay = {
    businessDate: businessDate,
    totalSales: totalSales,
    cashTotal: cashTotal,
    cardTotal: cardTotal,
    transactionCount: transactionCount,
    
    // Cash reconciliation
    bills200: cashData.bills200,
    bills100: cashData.bills100,
    bills50: cashData.bills50,
    bills20: cashData.bills20,
    coins: cashData.coins,
    countedCash: cashData.countedTotal,
    cashDifference: cashData.diff,
    
    closedAt: new Date().toISOString(),
    closedBy: 'Owner'
  };
  
  try {
    // Save closed day record
    const closedDayId = await saveClosedDay(closedDay);
    
    // Update all transactions for this day to link them to closed day
    for (const tx of transactions) {
      await updateTransaction(tx.id, { closedDayId: closedDayId });
    }
    
    // Clear current business date (next sale creates new day)
    clearCurrentBusinessDate();
    
    // Show success
    showToast('‚úì G√ºn kapatƒ±ldƒ±', 'success');
    
    // Close modal and return to scanner
    summaryModal.classList.remove('show');
    resumeScanner();
    
  } catch (err) {
    console.error('Close day error:', err);
    showToast('G√ºn kapatƒ±lamadƒ±', 'warning');
  }
}

function returnToScanner() {
  summaryModal.classList.remove('show');
  resumeScanner();
  showToast('Yeni satƒ±≈ü i√ßin hazƒ±r', 'success');
}

function closeSummaryModal() {
  summaryModal.classList.remove('show');
  resumeScanner();
}

// ========================================
// SCANNING LOGIC
// ========================================
async function handleBarcode(barcode) {
  if (scanLocked) return;
  scanLocked = true;
  
  try {
    let product = await getProduct(barcode);
    
    if (product) {
      // Product exists - add to cart immediately
      cart.push({ ...product });
      showToast(`‚úì ${product.name} - ‚Ç∫${product.price.toFixed(2)}`, 'success');
      vibrate();
      updateCartUI();
      
      // Resume scanning after delay
      setTimeout(() => scanLocked = false, 1000);
    } else {
      // Product NOT found - open Quick Add modal
      pauseScanner();
      openQuickAddModal(barcode);
      scanLocked = false;
    }
    
  } catch (err) {
    console.error('Scan error:', err);
    showToast('Hata olu≈ütu', 'warning');
    setTimeout(() => scanLocked = false, 1000);
  }
}

function pauseScanner() {
  if (codeReader) {
    codeReader.reset();
  }
}

function resumeScanner() {
  startScanner();
}

// ========================================
// CAMERA SCANNER
// ========================================
async function startScanner() {
  try {
    status.textContent = 'Ba≈ülatƒ±lƒ±yor...';
    
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: 'environment',
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    });
    
    video.srcObject = stream;
    
    codeReader = new ZXing.BrowserMultiFormatReader();
    
    codeReader.decodeFromVideoDevice(
      undefined,
      video,
      (result, err) => {
        if (result) {
          handleBarcode(result.text);
        }
      }
    );
    
    status.textContent = 'Hazƒ±r';
    
  } catch (err) {
    console.error('Camera error:', err);
    status.textContent = 'Kamera hatasƒ±';
    showToast('Kamera a√ßƒ±lamadƒ±', 'warning');
  }
}

// ========================================
// MANUAL BARCODE INPUT
// ========================================
manualBtn.onclick = () => {
  pauseScanner();
  inputModal.classList.add('show');
  barcodeInput.value = '';
  barcodeInput.focus();
};

cancelInput.onclick = () => {
  inputModal.classList.remove('show');
  resumeScanner();
};

addManual.onclick = () => {
  const barcode = barcodeInput.value.trim();
  if (barcode) {
    inputModal.classList.remove('show');
    handleBarcode(barcode);
    resumeScanner();
  }
};

barcodeInput.onkeypress = (e) => {
  if (e.key === 'Enter') addManual.click();
};

// ========================================
// QUICK ADD PRODUCT MODAL
// ========================================
function openQuickAddModal(barcode) {
  quickBarcode.value = barcode;
  quickPrice.value = '';
  quickName.value = '';
  quickAddModal.classList.add('show');
  
  setTimeout(() => quickPrice.focus(), 300);
}

function closeQuickAddModal() {
  quickAddModal.classList.remove('show');
  resumeScanner();
}

cancelQuickAdd.onclick = () => {
  closeQuickAddModal();
  showToast('ƒ∞ptal edildi', 'warning');
};

saveQuickAdd.onclick = async () => {
  const barcode = quickBarcode.value.trim();
  const price = parseFloat(quickPrice.value);
  const name = quickName.value.trim();
  
  if (!price || price <= 0) {
    quickPrice.classList.add('error');
    showToast('Fiyat girilmeli', 'warning');
    quickPrice.focus();
    return;
  }
  
  quickPrice.classList.remove('error');
  
  const newProduct = {
    barcode: barcode,
    name: name || `√úr√ºn ${barcode.slice(-4)}`,
    price: price,
    stock: 999
  };
  
  try {
    await addProduct(newProduct);
    cart.push({ ...newProduct });
    updateCartUI();
    closeQuickAddModal();
    showToast(`‚úì ${newProduct.name} eklendi`, 'success');
    vibrate();
  } catch (err) {
    console.error('Quick add error:', err);
    showToast('Kayƒ±t hatasƒ±', 'warning');
  }
};

quickPrice.onkeypress = (e) => {
  if (e.key === 'Enter') quickName.focus();
};

quickName.onkeypress = (e) => {
  if (e.key === 'Enter') saveQuickAdd.click();
};

// ========================================
// CART MODAL
// ========================================
cartBtn.onclick = () => {
  pauseScanner();
  cartModal.classList.add('show');
};

closeCart.onclick = () => {
  cartModal.classList.remove('show');
  resumeScanner();
};

checkoutBtn.onclick = () => {
  if (cart.length === 0) return;
  
  const total = cart.reduce((sum, item) => sum + item.price, 0);
  const itemCount = cart.length;
  
  // Store pending sale info
  pendingSaleTotal = total;
  
  // Show payment modal
  paymentTotal.textContent = `‚Ç∫${total.toFixed(2)}`;
  paymentModal.classList.add('show');
};

// ========================================
// RECEIPT QR GENERATION
// ========================================

async function generateReceiptQR(transaction) {
  const shopName = await getSetting('shopName') || 'Prestige Market';
  const currency = await getSetting('currency') || '‚Ç∫';
  
  // Get receipt number (count of today's transactions)
  const todayTx = await getTransactionsByBusinessDate(transaction.businessDate);
  const receiptNumber = todayTx.length;
  
  // Format date/time in Turkish
  const date = new Date(transaction.timestamp);
  const dateStr = date.toLocaleDateString('tr-TR');
  const timeStr = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
  
  // Create compact receipt data
  const receiptData = {
    s: shopName,
    d: `${dateStr} ${timeStr}`,
    i: transaction.items.map(item => [item.name, item.price]),
    t: transaction.total,
    p: transaction.paymentType === 'cash' ? 'Nakit' : 'Kart',
    n: `#${receiptNumber}`
  };
  
  // Create full receipt HTML (embedded in QR)
  const receiptHTML = `<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Fi≈ü ${receiptData.n}</title>
<style>
body{font-family:monospace;max-width:300px;margin:20px auto;background:#000;color:#fff;padding:20px}
h2{text-align:center;border-bottom:2px solid #00ff88;padding-bottom:10px;margin-bottom:20px}
.line{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #333}
.total{font-size:24px;font-weight:bold;color:#00ff88;text-align:center;margin:20px 0;padding:15px;background:rgba(0,255,136,0.1);border-radius:8px}
.meta{text-align:center;color:#666;font-size:12px;margin-top:20px}
</style>
</head>
<body>
<h2>${receiptData.s}</h2>
<div class="meta">${receiptData.d}</div>
<div class="meta">Fi≈ü ${receiptData.n}</div>
<hr>
${receiptData.i.map(item => `<div class="line"><span>${item[0]}</span><span>${currency}${item[1].toFixed(2)}</span></div>`).join('')}
<div class="total">TOPLAM: ${currency}${receiptData.t.toFixed(2)}</div>
<div class="meta">√ñdeme: ${receiptData.p}</div>
</body>
</html>`;
  
  // Encode as data URL (works offline)
  const base64HTML = btoa(unescape(encodeURIComponent(receiptHTML)));
  const dataURL = `data:text/html;base64,${base64HTML}`;
  
  return dataURL;
}

async function showReceiptModal(transaction) {
  try {
    // Generate QR data URL
    const qrData = await generateReceiptQR(transaction);
    
    // Generate QR code on canvas
    await QRCode.toCanvas(qrCanvas, qrData, {
      width: 250,
      margin: 2,
      color: {
        dark: '#000000',
        light: '#ffffff'
      }
    });
    
    // Update receipt info
    receiptAmount.textContent = `‚Ç∫${transaction.total.toFixed(2)}`;
    receiptPayment.textContent = transaction.paymentType === 'cash' ? 'üíµ Nakit' : 'üí≥ Kart';
    
    // Show modal
    receiptModal.classList.add('show');
    
    // Auto-close after 5 seconds
    setTimeout(() => {
      if (receiptModal.classList.contains('show')) {
        closeReceiptModal();
      }
    }, 5000);
    
  } catch (err) {
    console.error('Receipt QR error:', err);
    showToast('Fi≈ü olu≈üturulamadƒ±', 'warning');
  }
}

function closeReceiptModal() {
  receiptModal.classList.remove('show');
  resumeScanner();
}

closeReceipt.onclick = closeReceiptModal;
// ========================================
// PAYMENT MODAL HANDLERS
// ========================================
cancelPayment.onclick = () => {
  paymentModal.classList.remove('show');
};

paymentCash.onclick = () => {
  completeSale('cash');
};

paymentCard.onclick = () => {
  completeSale('card');
};

async function completeSale(paymentType) {
  if (cart.length === 0) return;
  
  const total = cart.reduce((sum, item) => sum + item.price, 0);
  const itemCount = cart.length;
  
  // Create transaction with all required fields
  const transaction = {
    businessDate: getCurrentBusinessDate(),
    timestamp: new Date().toISOString(),
    paymentType: paymentType,
    items: [...cart],
    total: total,
    itemCount: itemCount,
    closedDayId: null  // Will be set when day is closed
  };
  
  try {
    await saveTransaction(transaction);
    
    // Clear cart
    cart = [];
    updateCartUI();
    
    // Close payment modal and cart modal
    paymentModal.classList.remove('show');
    cartModal.classList.remove('show');
    
    // Show receipt QR
    await showReceiptModal(transaction);
    
    // Show success toast
    const paymentLabel = paymentType === 'cash' ? 'Nakit' : 'Kart';
    showToast(`‚úì Satƒ±≈ü tamamlandƒ± (${paymentLabel})`, 'success');
    vibrate();
    
  } catch (err) {
    console.error('Save transaction error:', err);
    showToast('Satƒ±≈ü kaydedilemedi', 'warning');
  }
}

// ========================================
// DAILY SUMMARY MODAL
// ========================================
summaryBtn.onclick = async () => {
  pauseScanner();
  summaryModal.classList.add('show');
  await renderDailySummary();
};

closeSummary.onclick = () => {
  summaryModal.classList.remove('show');
  resumeScanner();
};

// ========================================
// INIT
// ========================================
(async function init() {
  await initDB();
  
  // Initialize default settings if first run
  const shopName = await getSetting('shopName');
  if (!shopName) {
    await setSetting('shopName', 'Prestige Market');
    await setSetting('currency', '‚Ç∫');
  }
  
  await seedProducts();
  await startScanner();
  updateCartUI();
})();

// Expose for inline handlers
window.removeFromCart = removeFromCart;
window.closeDaySummary = closeDaySummary;
window.closeSummaryModal = closeSummaryModal;
window.returnToScanner = returnToScanner;
window.closeReceiptModal = closeReceiptModal;
</script>

</body>
</html>
